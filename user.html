<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Player</title>
    <style>
        :root { --primary: #10B981; --dark: #065F46; --bg: #E0E7FF; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 15px; }
        
        .card { background: var(--white); width: 100%; max-width: 480px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none !important; }

        /* Auth */
        .input-box { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn:hover { background: var(--dark); }
        .link { color: #4F46E5; cursor: pointer; margin-top: 15px; display: inline-block; font-size: 0.9rem; }

        /* Timer */
        .timer-container { width: 100%; background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
        .timer-bar { height: 100%; background: #EF4444; width: 100%; transition: width 1s linear; }

        /* Quiz */
        .opt-btn { width: 100%; padding: 15px; margin-bottom: 10px; background: #f3f4f6; border: 2px solid transparent; border-radius: 8px; text-align: left; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .opt-btn:hover { background: #e5e7eb; border-color: #d1d5db; }
        .correct { background: #D1FAE5 !important; border-color: #10B981 !important; }
        .wrong { background: #FEE2E2 !important; border-color: #EF4444 !important; }
        
        h3 { color: #1f2937; margin-bottom: 20px; font-size: 1.3rem; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="card">
    
    <!-- 1. AUTH SCREEN -->
    <div id="screen-auth">
        <h2 id="authTitle">Quiz Login</h2>
        <input type="email" id="email" class="input-box" placeholder="Email Address">
        <input type="password" id="pass" class="input-box" placeholder="Password">
        <button class="btn" id="authBtn">Log In</button>
        <span class="link" id="toggleMode">Create an account</span>
    </div>

    <!-- 2. LOBBY SCREEN (Set Name) -->
    <div id="screen-lobby" class="hidden">
        <h3>Welcome!</h3>
        <p style="color:#666; font-size:0.9rem;">Logged in as: <span id="userEmailDisplay"></span></p>
        <p>Set your display name to join.</p>
        <input type="text" id="nickname" class="input-box" placeholder="Your Name (e.g., Alex)">
        <button class="btn" id="joinBtn">Enter Waiting Room</button>
        <button class="btn" id="logoutBtn" style="background:#6b7280; margin-top:10px;">Log Out</button>
    </div>

    <!-- 3. WAITING SCREEN -->
    <div id="screen-wait" class="hidden">
        <div style="font-size:3rem;" class="pulse">‚è≥</div>
        <h3>Waiting for Host...</h3>
        <p style="color:#10B981; font-weight:bold; margin-bottom: 5px;">Welcome, <span id="displayNameWait"></span>!</p>
        <p style="font-size:0.9rem; color:#666;">The quiz will start automatically when the admin goes LIVE.</p>
        
        <div style="margin-top:20px; padding:10px; background:#f9fafb; border-radius:8px;">
            <small>Status:</small><br>
            <strong id="statusIndicator" style="color:#F59E0B;">Checking...</strong>
        </div>
        <button class="btn" id="waitLogoutBtn" style="background:#EF4444; margin-top:15px; font-size:0.8rem; padding:10px;">Log Out / Change Name</button>
    </div>

    <!-- 4. GAME SCREEN -->
    <div id="screen-game" class="hidden">
        <div class="timer-container"><div id="timerBar" class="timer-bar"></div></div>
        
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:#6b7280; font-size:0.9rem;">
            <span>Time: <b id="timerText">10</b>s</span>
            <span>Question: <b id="currentQ">1</b> / <b id="totalQ">10</b></span>
        </div>

        <h3 id="qText" style="text-align:left;">Loading Question...</h3>
        <div id="options"></div>
    </div>

    <!-- 5. RESULT SCREEN -->
    <div id="screen-result" class="hidden">
        <h2>Quiz Completed</h2>
        <div style="font-size:4rem; font-weight:800; color:var(--primary); margin:20px 0;" id="finalScore">0</div>
        <p>Your score has been saved!</p>
        <button class="btn" onclick="location.reload()">Back to Home</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // -----------------------------------------------------------
    // REPLACE THIS WITH YOUR FIREBASE CONFIG
    // -----------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyC4S8MPl-3SsAN-LS-u-T1wAQCR-gdUK3U",
  authDomain: "quiz-f3cf8.firebaseapp.com",
  databaseURL: "https://quiz-f3cf8-default-rtdb.firebaseio.com",
  projectId: "quiz-f3cf8",
  storageBucket: "quiz-f3cf8.firebasestorage.app",
  messagingSenderId: "890401432632",
  appId: "1:890401432632:web:72fa69191a7b7e938a32cd"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // STATE
    let currentUser = null;
    let nickname = "";
    let questions = [];
    let qIndex = 0;
    let score = 0;
    let timerRef = null;
    let timeLeft = 10;
    let isRegister = false;

    // --- DOM HELPERS ---
    const screens = {
        auth: document.getElementById('screen-auth'),
        lobby: document.getElementById('screen-lobby'),
        wait: document.getElementById('screen-wait'),
        game: document.getElementById('screen-game'),
        result: document.getElementById('screen-result')
    };
    function show(id) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[id].classList.remove('hidden');
    }

    // --- 1. AUTH & AUTO-LOGIN LOGIC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('userEmailDisplay').innerText = user.email;
            
            // CHECK LOCAL STORAGE FOR NICKNAME
            const savedName = localStorage.getItem('quiz_nickname');
            
            if (savedName) {
                // NAME EXISTS -> SKIP LOBBY -> GO TO WAIT
                nickname = savedName;
                enterWaitingRoom();
            } else {
                // NO NAME -> SHOW LOBBY TO ENTER NAME
                show('lobby');
            }
        } else {
            currentUser = null;
            show('auth');
        }
    });

    document.getElementById('authBtn').addEventListener('click', () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        const action = isRegister ? createUserWithEmailAndPassword : signInWithEmailAndPassword;
        action(auth, email, pass).catch(e => alert(e.message));
    });

    document.getElementById('toggleMode').addEventListener('click', () => {
        isRegister = !isRegister;
        document.getElementById('authTitle').innerText = isRegister ? "Sign Up" : "Login";
        document.getElementById('authBtn').innerText = isRegister ? "Sign Up" : "Log In";
        document.getElementById('toggleMode').innerText = isRegister ? "Have an account? Login" : "Create an account";
    });

    // Handle standard Logout (from Lobby)
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('quiz_nickname'); // Clear name
        signOut(auth);
    });

    // Handle Logout from Waiting Room
    document.getElementById('waitLogoutBtn').addEventListener('click', () => {
        localStorage.removeItem('quiz_nickname'); // Clear name
        signOut(auth);
    });

    // --- 2. LOBBY & WAITING ---
    document.getElementById('joinBtn').addEventListener('click', () => {
        const inputName = document.getElementById('nickname').value.trim();
        if(!inputName) return alert("Please enter a name.");
        
        // SAVE TO LOCAL STORAGE
        localStorage.setItem('quiz_nickname', inputName);
        nickname = inputName;

        enterWaitingRoom();
    });

    // Shared function to enter waiting room
    function enterWaitingRoom() {
        document.getElementById('displayNameWait').innerText = nickname;
        show('wait');
        listenForGameStart();
    }

    function listenForGameStart() {
        onValue(ref(db, 'quizStatus'), (snap) => {
            const isLive = snap.val();
            const statusEl = document.getElementById('statusIndicator');

            if(isLive) {
                statusEl.innerText = "LIVE! STARTING...";
                statusEl.style.color = "#10B981";
                // Only start if currently in waiting room
                if(!screens.wait.classList.contains('hidden')) {
                    fetchQuestions();
                }
            } else {
                statusEl.innerText = "HOST IS OFFLINE";
                statusEl.style.color = "#EF4444";
            }
        });
    }

    async function fetchQuestions() {
        const snap = await get(ref(db, 'questions'));
        if(snap.exists()) {
            questions = Object.values(snap.val());
            if(questions.length > 0) {
                qIndex = 0; score = 0;
                show('game');
                loadQuestion();
            }
        }
    }

    // --- 3. GAMEPLAY ---
    function loadQuestion() {
        if(qIndex >= questions.length) return finishGame();

        const q = questions[qIndex];
        
        // UI
        document.getElementById('currentQ').innerText = qIndex + 1;
        document.getElementById('totalQ').innerText = questions.length;
        document.getElementById('qText').innerText = q.text;
        
        const div = document.getElementById('options');
        div.innerHTML = "";

        q.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = "opt-btn";
            btn.innerText = opt;
            btn.onclick = () => handleAnswer(i, btn);
            div.appendChild(btn);
        });

        startTimer();
    }

    function startTimer() {
        timeLeft = 10;
        document.getElementById('timerText').innerText = timeLeft;
        document.getElementById('timerBar').style.width = "100%";
        
        clearInterval(timerRef);
        timerRef = setInterval(() => {
            timeLeft--;
            document.getElementById('timerText').innerText = timeLeft;
            document.getElementById('timerBar').style.width = (timeLeft / 10 * 100) + "%";

            if(timeLeft <= 0) {
                clearInterval(timerRef);
                handleAnswer(-1, null); // Time up
            }
        }, 1000);
    }

    function handleAnswer(choiceIndex, btn) {
        clearInterval(timerRef);
        
        const correctIndex = questions[qIndex].correctIndex;
        const allBtns = document.querySelectorAll('.opt-btn');
        allBtns.forEach(b => b.disabled = true);

        if(choiceIndex === correctIndex) {
            score++;
            if(btn) btn.classList.add('correct');
        } else {
            if(btn) btn.classList.add('wrong');
            if(correctIndex < allBtns.length) allBtns[correctIndex].classList.add('correct');
        }

        setTimeout(() => {
            qIndex++;
            loadQuestion();
        }, 1500);
    }

    function finishGame() {
        show('result');
        document.getElementById('finalScore').innerText = score + "/" + questions.length;

        // Save to Firebase
        const uid = currentUser.uid;
        set(ref(db, `users/${uid}`), {
            name: nickname,
            email: currentUser.email,
            score: score,
            total: questions.length,
            timestamp: Date.now()
        });
    }

</script>
</body>
</html>